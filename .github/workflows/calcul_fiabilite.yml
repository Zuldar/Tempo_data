name: Tempo Fiabilité 
on:
  schedule:
    - cron: '15 10 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install dependencies
        run: pip install requests
      - name: Run Engine
        run: |
          python - <<EOF
          import requests
          import json
          from datetime import datetime, timedelta

          # --- CONFIGURATION DES POIDS ---
          W_METEO = 0.70  
          W_GRID  = 0.30  
          THRESHOLD_ROUGE = 72
          THRESHOLD_BLANC = 30  # Seuil abaissé pour plus de prudence

          def get_tempo_color(temp, gw, target_date):
              # Scores de Température
              if temp <= 0: t_score = 100
              elif temp <= 4: t_score = 90
              elif temp <= 7: t_score = 75
              elif temp <= 10: t_score = 45
              elif temp <= 12: t_score = 25
              else: t_score = 0
              
              # Scores Réseau (Flux GW)
              g_score = 100 if gw >= 80 else 80 if gw >= 72 else 50 if gw >= 65 else 20 if gw >= 58 else 0
              
              # Calcul Global
              global_score = (t_score * W_METEO) + (g_score * W_GRID)
              
              res = "BLEU"
              if global_score >= THRESHOLD_ROUGE: res = "ROUGE"
              elif global_score >= THRESHOLD_BLANC: res = "BLANC"
              
              # Verrous réglementaires
              day_wk = target_date.weekday()
              month = target_date.month
              if day_wk >= 5 and res == "ROUGE": res = "BLANC"
              if day_wk == 6: res = "BLEU"
              if not (11 <= month <= 12 or 1 <= month <= 3) and res == "ROUGE": res = "BLANC"
              return res

          # 1. Charger Stats
          try:
              with open('stats_fiabilite.json', 'r') as f: data = json.load(f)
              if not data or 'j1' not in data: raise ValueError
          except:
              data = {"j1": {"success":0, "total":0}, "j2": {"success":0, "total":0}, "j3": {"success":0, "total":0}, 
                      "predictions_j1":{}, "predictions_j2":{}, "predictions_j3":{}}

          # 2. VERIFICATION DU JOUR
          today_str = datetime.now().strftime('%Y-%m-%d')
          try:
              res_tempo = requests.get("https://www.api-couleur-tempo.fr/api/jourTempo/today").json()
              mapping = {1: "BLEU", 2: "BLANC", 3: "ROUGE"}
              couleur_reelle = mapping.get(res_tempo.get('codeJour'), "INCONNU")

              if couleur_reelle != "INCONNU":
                  for key in ['j1', 'j2', 'j3']:
                      pred_dict = data.get(f'predictions_{key}', {})
                      if today_str in pred_dict:
                          data[key]['total'] += 1
                          if pred_dict[today_str] == couleur_reelle:
                              data[key]['success'] += 1
                          del pred_dict[today_str]
          except: pass

          # 3. NOUVELLES PREDICTIONS J+1, J+2, J+3
          try:
              meteo = requests.get("https://api.open-meteo.com/v1/forecast?latitude=48.8566&longitude=2.3522&daily=temperature_2m_min&timezone=Europe%2FBerlin").json()
              flux_data = requests.get("https://raw.githubusercontent.com/Zuldar/Tempo_data/main/archive_tempo.json").json()
              gw = flux_data[0]['prevision_j1'] / 1000

              for offset in [1, 2, 3]:
                  target_date = datetime.now() + timedelta(days=offset)
                  t_str = target_date.strftime('%Y-%m-%d')
                  temp = meteo['daily']['temperature_2m_min'][offset]
                  data[f'predictions_j{offset}'][t_str] = get_tempo_color(temp, gw, target_date)
          except: pass

          # 4. Sauvegarde
          with open('stats_fiabilite.json', 'w') as f:
              json.dump(data, f, indent=2)
          EOF
      - name: Commit & Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "TempoEngine"
          git add stats_fiabilite.json
          git commit -m "MAJ Engine: Correction seuil Blanc et triple fiabilité" || echo "No changes to commit"
          git push || echo "No changes 
          to push"
