name: Tempo Expert Engine
on:
  schedule:
    - cron: '15 10 * * *' # 11h15 France
  workflow_dispatch: # Permet de lancer manuellement

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install dependencies
        run: pip install requests
      - name: Run Engine
        run: |
          python - <<EOF
          import requests
          import json
          from datetime import datetime, timedelta

          # 1. Charger les stats actuelles
          try:
              with open('stats_fiabilite.json', 'r') as f:
                  data = json.load(f)
          except Exception:
              data = {"success": 0, "total": 0, "predictions": {}}

          # 2. VERIFICATION DU JOUR (Performance)
          # On compare la prédiction qui était prévue pour aujourd'hui
          today_str = datetime.now().strftime('%Y-%m-%d')
          try:
              res_tempo = requests.get("https://www.api-couleur-tempo.fr/api/jourTempo/today").json()
              mapping = {1: "BLEU", 2: "BLANC", 3: "ROUGE"}
              couleur_reelle = mapping.get(res_tempo.get('codeJour'), "INCONNU")

              if today_str in data['predictions']:
                  pred_faite = data['predictions'][today_str]
                  if couleur_reelle != "INCONNU":
                      data['total'] += 1
                      if pred_faite == couleur_reelle:
                          data['success'] += 1
                      # Une fois vérifiée, on retire la prédiction du dictionnaire
                      del data['predictions'][today_str]
          except Exception as e:
              print(f"Erreur vérification: {e}")

          # 3. CALCUL PREDICTION POUR J+3 (Anticipation)
          target_date = datetime.now() + timedelta(days=3)
          target_str = target_date.strftime('%Y-%m-%d')
          
          try:
              # Météo J+3
              meteo = requests.get("https://api.open-meteo.com/v1/forecast?latitude=48.8566&longitude=2.3522&daily=temperature_2m_min&timezone=Europe%2FBerlin").json()
              temp_j3 = meteo['daily']['temperature_2m_min'][3]
              
              # Flux/GW (Récupération de ta data prevision_j1)
              flux_data = requests.get("https://raw.githubusercontent.com/Zuldar/Tempo_data/main/archive_tempo.json").json()
              gw = flux_data[0]['prevision_j1'] / 1000

              # Logique de calcul du score (Identique à ton JS)
              t_score = 100 if temp_j3 <= 0 else 80 if temp_j3 <= 4 else 50 if temp_j3 <= 8 else 20 if temp_j3 <= 12 else 0
              g_score = 100 if gw >= 80 else 60 if gw >= 70 else 20 if gw >= 60 else 0
              global_score = (t_score * 0.7) + (g_score * 0.3)
              
              res_pred = "BLEU"
              if global_score > 75: res_pred = "ROUGE"
              elif global_score > 50: res_pred = "BLANC"
              
              # Verrous réglementaires
              day_wk = target_date.weekday() # 5=Samedi, 6=Dimanche
              month = target_date.month
              if day_wk >= 5 and res_pred == "ROUGE": res_pred = "BLANC"
              if day_wk == 6: res_pred = "BLEU"
              if not (11 <= month <= 12 or 1 <= month <= 3) and res_pred == "ROUGE":
                  res_pred = "BLANC"

              # On enregistre la prédiction pour J+3
              data['predictions'][target_str] = res_pred
          except Exception as e:
              print(f"Erreur prédiction: {e}")

          # 4. Sauvegarde
          with open('stats_fiabilite.json', 'w') as f:
              json.dump(data, f, indent=2)
          EOF
      - name: Commit & Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "TempoEngine"
          git add stats_fiabilite.json
          git commit -m "MAJ Fiabilité & Prediction J+3" || exit 0
          git push
