name: Tempo Expert Engine
on:
  schedule:
    - cron: '15 10 * * *' # 11h15 France
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Install dependencies
        run: pip install requests
      - name: Run Engine
        run: |
          python - <<EOF
          import requests
          import json
          from datetime import datetime, timedelta

          # 1. Charger les stats actuelles
          with open('stats_fiabilite.json', 'r') as f:
              data = json.load(f)

          # 2. VERIFICATION DU JOUR (Performance)
          today_str = datetime.now().strftime('%Y-%m-%d')
          res_tempo = requests.get("https://www.api-couleur-tempo.fr/api/jourTempo/today").json()
          mapping = {"1": "BLEU", "2": "BLANC", "3": "ROUGE"}
          couleur_reelle = mapping.get(str(res_tempo.get('codeJour')), "INCONNU")

          if today_str in data['predictions']:
              pred_faite = data['predictions'][today_str]
              data['total'] += 1
              if pred_faite == couleur_reelle:
                  data['success'] += 1
              del data['predictions'][today_str]

          # 3. CALCUL PREDICTION J+3
          target_date = datetime.now() + timedelta(days=3)
          target_str = target_date.strftime('%Y-%m-%d')
          
          # Météo
          meteo = requests.get("https://api.open-meteo.com/v1/forecast?latitude=48.8566&longitude=2.3522&daily=temperature_2m_min&timezone=Europe%2FBerlin").json()
          temp_j3 = meteo['daily']['temperature_2m_min'][3]
          
          # Flux/GW (On récupère ta dernière data GitHub)
          flux_data = requests.get("https://raw.githubusercontent.com/Zuldar/Tempo_data/main/archive_tempo.json").json()
          gw = flux_data[0]['prevision_j1'] / 1000

          # Logique calculateProb (identique à ton JS)
          score = 0
          if temp_j3 <= 0: score = 100
          elif temp_j3 <= 4: score = 80
          elif temp_j3 <= 8: score = 50
          elif temp_j3 <= 12: score = 20
          
          gw_score = 100 if gw >= 80 else 60 if gw >= 70 else 20 if gw >= 60 else 0
          global_score = (score * 0.7) + (gw_score * 0.3)
          
          res = "BLEU"
          if global_score > 75: res = "ROUGE"
          elif global_score > 50: res = "BLANC"
          
          # Verrous réglementaires
          day_wk = target_date.weekday() # 5=Samedi, 6=Dimanche
          month = target_date.month
          if day_wk >= 5: res = "BLANC" if res == "ROUGE" else res
          if day_wk == 6: res = "BLEU"
          if not (11 <= month <= 12 or 1 <= month <= 3):
              if res == "ROUGE": res = "BLANC"

          data['predictions'][target_str] = res

          with open('stats_fiabilite.json', 'w') as f:
              json.dump(data, f, indent=2)
          EOF
      - name: Commit & Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "TempoEngine"
          git add stats_fiabilite.json
          git commit -m "Update Tempo Prediction & Stats" || exit 0
          g
          it push
