<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tempo Expert - Console Dynamique</title>
    <style>
        :root {
            --bg: #080808;
            --blue: #2979ff; --white: #ffffff; --red: #ff1744;
            --green: #00e676; --grey-light: #333;
        }
        body { background-color: var(--bg); color: white; font-family: sans-serif; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 450px; display: flex; flex-direction: column; gap: 12px; }
        
        /* BANDEAU DYNAMIQUE */
        #status-banner { 
            font-size: 0.65rem; font-weight: 900; text-align: center; padding: 12px; 
            border-radius: 12px; text-transform: uppercase; margin-bottom: 5px;
            transition: all 0.5s ease;
        }
        .status-ok { background: var(--green); color: #000; }
        .status-delayed { background: var(--blue); color: #fff; }
        .status-archive { background: var(--red); color: #fff; }

        .hphc-timer { text-align: center; font-size: 0.7rem; font-weight: 900; padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); margin-top: 5px; }
        .mode-bleu { background: rgba(41, 121, 255, 0.2); color: var(--blue); border-color: var(--blue); }
        .mode-blanc { background: rgba(255, 255, 255, 0.2); color: var(--white); border-color: var(--white); }
        .mode-rouge { background: rgba(255, 23, 68, 0.2); color: var(--red); border-color: var(--red); }

        .box { background: rgba(255,255,255,0.05); border-radius: 20px; padding: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .split-grid { display: grid; grid-template-columns: 1fr 1.15fr; gap: 12px; }
        .side-title { font-size: 0.55rem; font-weight: 900; color: var(--blue); margin-bottom: 8px; text-transform: uppercase; }
        .data-row { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.02); padding: 5px 8px; border-radius: 8px; margin-bottom: 4px; font-size: 0.55rem; }
        .val-bold { font-weight: 900; }
        .arrow { font-size: 0.7rem; margin-right: 4px; font-weight: bold; }

        .update-banner { background: var(--green); color: #000; font-size: 0.6rem; font-weight: 900; text-align: center; padding: 8px; border-radius: 8px; text-transform: uppercase; margin: 10px 0; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .card-rt { border-radius: 20px; padding: 15px; position: relative; border: 1px solid rgba(255,255,255,0.1); }
        .is-bleu { background: linear-gradient(135deg, #0044ff 0%, #001133 100%); color: white;}
        .is-blanc { background: linear-gradient(135deg, #ffffff 0%, #777777 100%); color: #000; }
        .is-rouge { background: linear-gradient(135deg, #ff0000 0%, #440000 100%); color: white;}
        
        button { width: 100%; padding: 15px; border-radius: 12px; border: none; background: #222; color: #fff; font-weight: 900; cursor: pointer; border: 1px solid #333; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div id="status-banner">Initialisation...</div>
    
    <div id="hphc-display" class="hphc-timer">Analyse Tempo...</div>

    <div class="box">
        <div class="split-grid">
            <div class="prod-col">
                <div class="side-title">Production FR</div>
                <div id="prod-list"></div>
                <div style="margin-top:10px; border-top:1px dashed #333; padding-top:5px;">
                    <div id="total-gw" style="font-size:1rem; font-weight:900; color:var(--green);">-- GW</div>
                </div>
            </div>
            <div class="flux-col" style="border-left: 1px solid #222; padding-left:10px;">
                <div class="side-title">Flux Voisins</div>
                <div id="flux-list"></div>
                <div id="total-solde" style="font-size:1rem; font-weight:900; margin-top:10px;">-- MW</div>
            </div>
        </div>
    </div>

    <div class="update-banner">Calendrier Officiel Tempo</div>
    <div class="grid-2" id="rt-days"></div>

    <button id="refresh-btn">ðŸ”„ SYNCHRONISER LA CONSOLE</button>
</div>

<script>
(function() {
    const pseudo = "Zuldar", depot = "Tempo_data";
    const API_LOCAL = `https://raw.githubusercontent.com/${pseudo}/${depot}/main/archive_tempo.json?cb=`;
    const API_TEMPO = "https://www.api-couleur-tempo.fr/api/jourTempo/today";
    const API_TMW = "https://www.api-couleur-tempo.fr/api/jourTempo/tomorrow";

    async function refresh() {
        try {
            const resp = await fetch(API_LOCAL + Date.now());
            const mix = await resp.json();
            const f = mix[0];
            
            if (f) {
                const now = new Date();
                const dataDate = new Date(f.date_heure);
                const diffMs = now - dataDate;
                const diffHours = diffMs / (1000 * 60 * 60);
                
                const banner = document.getElementById('status-banner');
                const isSameDay = now.toDateString() === dataDate.toDateString();

                // LOGIQUE DES COULEURS
                if (!isSameDay) {
                    banner.className = "status-archive";
                    banner.innerHTML = `âš ï¸ MODE ARCHIVE : DONNÃ‰ES DU ${dataDate.toLocaleDateString('fr-FR')}`;
                } else if (diffHours > 2) {
                    banner.className = "status-delayed";
                    banner.innerHTML = `â³ FLUX RETARDÃ‰ (+2H) : RÃ‰CEPTION Ã€ ${f.heure}`;
                } else {
                    banner.className = "status-ok";
                    banner.innerHTML = `âœ… FLUX EN DIRECT : MIS Ã€ JOUR Ã€ ${f.heure}`;
                }

                // AFFICHAGE PROD
                const sources = [{l:'NUC', v:f.nucleaire}, {l:'EOL', v:f.eolien}, {l:'HYD', v:f.hydraulique}, {l:'GAZ', v:f.gaz}];
                let totalProd = 0;
                document.getElementById('prod-list').innerHTML = sources.map(s => {
                    totalProd += (s.v || 0);
                    return `<div class="data-row"><span>${s.l}</span><span class="val-bold">${Math.round(s.v/1000)}k</span></div>`;
                }).join('');
                document.getElementById('total-gw').innerText = (totalProd/1000).toFixed(1) + " GW";

                // AFFICHAGE FLUX
                const neighbors = [{k:'angleterre', n:'UK ðŸ‡¬ðŸ‡§'}, {k:'allemagne_belgique', n:'DE ðŸ‡©ðŸ‡ª'}, {k:'espagne', n:'ES ðŸ‡ªðŸ‡¸'}, {k:'italie', n:'IT ðŸ‡®ðŸ‡¹'}, {k:'suisse', n:'CH ðŸ‡¨H'}, {k:'belgique', n:'BE ðŸ‡§ðŸ‡ª'}];
                let solde = 0;
                document.getElementById('flux-list').innerHTML = neighbors.map(n => {
                    const val = Math.round((f['ech_comm_' + n.k] || 0) * -1);
                    solde += val;
                    const arrow = val >= 0 ? '<span class="arrow" style="color:var(--blue)">â†‘</span>' : '<span class="arrow" style="color:var(--red)">â†“</span>';
                    return `<div class="data-row"><span>${n.n}</span><span class="val-bold">${arrow}${Math.abs(val)}</span></div>`;
                }).join('');
                document.getElementById('total-solde').innerText = (solde>=0?"+":"")+solde+" MW";
                document.getElementById('total-solde').style.color = solde>=0?"var(--green)":"var(--red)";
            }

            // TEMPO
            const [j0, j1] = await Promise.all([fetch(API_TEMPO).then(r => r.json()), fetch(API_TMW).then(r => r.json())]);
            const colorMap = { 1: "BLEU", 2: "BLANC", 3: "ROUGE" };
            
            // HP/HC
            const h = new Date().getHours();
            const label = (h >= 6 && h < 22) ? "âš¡ HEURES PLEINES" : "ðŸŒ™ HEURES CREUSES";
            const curCol = j0.codeJour > 0 ? colorMap[j0.codeJour].toLowerCase() : "null";
            document.getElementById('hphc-display').className = `hphc-timer mode-${curCol}`;
            document.getElementById('hphc-display').innerText = label;

            document.getElementById('rt-days').innerHTML = [j0, j1].map((info, i) => {
                const d = new Date(); d.setDate(d.getDate() + i);
                const color = info.codeJour > 0 ? colorMap[info.codeJour] : "ATTENTE";
                return `<div class="card-rt is-${color.toLowerCase()}"><div style="font-size:0.55rem; font-weight:900;">${d.toLocaleDateString('fr-FR', {weekday: 'long', day: 'numeric'})}</div><div style="font-size:1.1rem; font-weight:900;">${color}</div></div>`;
            }).join('');

        } catch (e) { console.error(e); }
    }

    document.getElementById('refresh-btn').addEventListener('click', refresh);
    refresh();
})();
</script>
</body>
</html>
