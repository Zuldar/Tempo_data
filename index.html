<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tempo Master Expert - Flux PrÃ©cision</title>
    <style>
        :root {
            --bg: #050505; --card: #111; 
            --gold-linear: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            --blue: #2979ff; --red: #ff1744; --green: #00e676; --orange: #ff9800;
            --grad-blue: linear-gradient(135deg, #0044ff 0%, #001133 100%);
            --grad-white: linear-gradient(135deg, #ffffff 0%, #777777 100%);
            --grad-rouge: linear-gradient(135deg, #ff0000 0%, #440000 100%);
        }
        body { background: var(--bg); color: white; font-family: -apple-system, sans-serif; margin: 0; padding: 10px; }
        .container { max-width: 420px; margin: auto; display: flex; flex-direction: column; gap: 12px; }
        
        .status-bar { text-align: center; font-size: 0.65rem; font-weight: 900; padding: 8px; border-radius: 10px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .status-live { background: var(--green); color: black; }
        
        .badge-base { 
            position: absolute; top: 10px; right: 10px; 
            font-size: 0.5rem; padding: 4px 10px; border-radius: 5px; 
            font-weight: 900; box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            letter-spacing: 0.5px; text-transform: uppercase;
            background-size: 200% auto;
            animation: shine 3s linear infinite;
        }
        @keyframes shine { to { background-position: 200% center; } }
        .badge-estimation { background-image: linear-gradient(135deg, #6a11cb 0%, #ab66ff 25%, #6a11cb 50%, #ab66ff 75%, #6a11cb 100%); color: white; }
        .badge-rte { background-image: linear-gradient(135deg, #00b09b 0%, #96ffea 25%, #00b09b 50%, #96ffea 75%, #00b09b 100%); color: #000; }
        .badge-officiel { background-image: var(--gold-linear); color: #111; }

        /* NOUVEAU STYLE DU SCORE : DISCRET ET BIEN PLACÃ‰ */
        .score-container {
            margin-top: 8px;
            text-align: right;
            font-size: 0.52rem;
            font-weight: 800;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .score-val { color: var(--green); opacity: 0.8; }

        .card-main { background: var(--card); border-radius: 20px; padding: 15px; border: 1px solid #222; }
        .flux-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .flux-item { background: #1a1a1a; padding: 8px 12px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; font-weight: 600; }
        
        .solde-container { text-align: center; padding-top: 15px; border-top: 1px dashed #333; display: flex; justify-content: center; align-items: center; }
        .flux-visual { display: flex; align-items: center; gap: 12px; height: 40px; }
        .arrow { font-size: 1.8rem; transition: transform 0.5s; font-weight: bold; line-height: 1; }
        .solde-val { font-weight: 900; font-size: 1.5rem; letter-spacing: -0.5px; }
        
        .import-style { color: var(--red); }
        .export-style { color: var(--green); }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .card-rt { border-radius: 20px; padding: 15px; position: relative; border: 1px solid rgba(255,255,255,0.1); min-height: 85px; display: flex; flex-direction: column; justify-content: center; transition: all 0.5s ease; }
        .is-bleu { background: var(--grad-blue); color: white; }
        .is-blanc { background: var(--grad-white); color: #000 !important; }
        .is-rouge { background: var(--grad-rouge); color: white; }
        .is-attente { background: #222; color: #555; }

        .prob-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .prob-card { position: relative; background: #151515; border-radius: 18px; padding: 12px; border: 2px solid #222; transition: border-color 0.5s; }
        .prob-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .prob-line { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; font-size: 0.7rem; font-weight: 800; }
        .dot { width: 10px; height: 10px; border-radius: 50%; }
        .prob-bar-bg { flex-grow: 1; height: 6px; background: #222; border-radius: 3px; overflow: hidden; }
        .prob-bar-fill { height: 100%; transition: width 1s ease; }
        
        .bar-wrap { margin-bottom: 12px; }
        .bar-info { display: flex; justify-content: space-between; font-size: 0.7rem; font-weight: 900; margin-bottom: 5px; }
        .bar-base { background: #1a1a1a; height: 10px; border-radius: 5px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 5px; transition: width 1s ease-in-out; }
    </style>
</head>
<body>

<div class="container">
    <div id="data-status" class="status-bar">Sync Flux...</div>

    <div class="card-main">
        <div class="flux-grid" id="flux-grid"></div>
        <div class="solde-container">
            <div class="flux-visual" id="flux-display"></div>
        </div>
    </div>

    <div style="margin-top: 5px;">
        <div id="tempo-status" class="status-bar" style="background:#008148;color:white;margin-bottom:8px;">RÃ©seau Tempo</div>
        <div class="grid-2">
            <div id="card-today" class="card-rt">
                <span class="badge-base badge-officiel">OFFICIEL</span>
                <div id="date-today" style="font-size: 0.6rem; font-weight: 800; opacity: 0.8; text-transform: uppercase;">...</div>
                <div id="text-today" style="font-size: 1.1rem; font-weight: 900;">...</div>
            </div>
            <div id="card-tomorrow" class="card-rt">
                <span id="badge-tomorrow" class="badge-base">...</span>
                <div id="date-tomorrow" style="font-size: 0.6rem; font-weight: 800; opacity: 0.8; text-transform: uppercase;">...</div>
                <div id="text-tomorrow" style="font-size: 1.1rem; font-weight: 900;">...</div>
            </div>
        </div>
    </div>

    <div class="prob-container">
        <div id="card-j2" class="prob-card">
            <div class="prob-header">
                <span id="label-j2" style="font-size: 0.6rem; font-weight: 900; opacity: 0.6;">...</span>
                <span id="temp-j2" style="font-size: 0.8rem; font-weight: 900;">--Â°C</span>
            </div>
            <div id="prob-rows-j2"></div>
            <div class="score-container">PrÃ©cision J+2: <span id="val-j2" class="score-val">--%</span></div>
        </div>
        <div id="card-j3" class="prob-card">
            <div class="prob-header">
                <span id="label-j3" style="font-size: 0.6rem; font-weight: 900; opacity: 0.6;">...</span>
                <span id="temp-j3" style="font-size: 0.8rem; font-weight: 900;">--Â°C</span>
            </div>
            <div id="prob-rows-j3"></div>
            <div class="score-container">PrÃ©cision J+3: <span id="val-j3" class="score-val">--%</span></div>
        </div>
    </div>

    <div class="card-main">
        <div style="font-size: 0.6rem; font-weight: 900; color: #444; margin-bottom: 15px;">SAISON 2025-26 (RESTANTS)</div>
        <div id="stats-container"></div>
    </div>
</div>

<script>
    const labels = { 1: "BLEU", 2: "BLANC", 3: "ROUGE" };
    let currentGW = 65;
    let daysLeft = { rouge: 22, blanc: 43 };

    async function updateFlux() {
        try {
            const r = await fetch("https://raw.githubusercontent.com/Zuldar/Tempo_data/main/archive_tempo.json?t=" + Date.now());
            const [d] = await r.json();
            currentGW = d.prevision_j1 / 1000;
            const pays = [{id:'uk',n:'UK',f:'ðŸ‡¬ðŸ‡§'},{id:'de_be',n:'ALL/BEL',f:'ðŸ‡©ðŸ‡ªðŸ‡§ðŸ‡ª'},{id:'it',n:'ITA',f:'ðŸ‡®ðŸ‡¹'},{id:'es',n:'ESP',f:'ðŸ‡ªðŸ‡¸'},{id:'ch',n:'SUI',f:'ðŸ‡¨ðŸ‡­'}];
            let solde = 0, html = "";
            pays.forEach(p => { 
                const v = d[p.id] || 0; solde += v; 
                html += `<div class="flux-item"><span>${p.f} ${p.n}</span><span style="color:${v>0?'var(--red)':'var(--green)'}">${v>0?'â†“':'â†‘'} ${Math.abs(v)}</span></div>`; 
            });
            document.getElementById('flux-grid').innerHTML = html;
            const display = document.getElementById('flux-display'); const absSolde = Math.abs(solde);
            display.innerHTML = solde > 0 ? `<span style="font-size: 1.8rem; order: 2;">ðŸ‡«ðŸ‡·</span><span class="arrow import-style" style="order: 1;">âž¡</span><span class="solde-val import-style" style="order: 0;">${absSolde} MW</span>` : `<span style="font-size: 1.8rem; order: 0;">ðŸ‡«ðŸ‡·</span><span class="arrow export-style" style="order: 1;">âž¡</span><span class="solde-val export-style" style="order: 2;">${absSolde} MW</span>`;
            document.getElementById('data-status').innerText = "RÃ‰SEAU LIVE â€¢ " + new Date().toLocaleTimeString();
            document.getElementById('data-status').className = "status-bar status-live";
        } catch (e) {}
    }

    function calculateProb(temp, gw, targetDate) {
        let r = 0, w = 0, b = 0;
        const dayOfWeek = targetDate.getDay(); 
        const month = targetDate.getMonth() + 1;

        let tempScore = (temp <= 0) ? 100 : (temp <= 4) ? 80 : (temp <= 8) ? 50 : (temp <= 12) ? 20 : 0;
        let gwScore = (gw >= 80) ? 100 : (gw >= 70) ? 60 : (gw >= 60) ? 20 : 0;
        let globalScore = (tempScore * 0.7) + (gwScore * 0.3);

        if (globalScore > 75) { r = 70; w = 30; b = 0; }
        else if (globalScore > 50) { r = 10; w = 70; b = 20; }
        else if (globalScore > 25) { r = 0; w = 25; b = 75; }
        else { r = 0; w = 0; b = 100; }

        if (dayOfWeek === 0 || dayOfWeek === 6) { w += r; r = 0; }
        if (dayOfWeek === 0) { b = 100; w = 0; r = 0; }
        if (month > 3 && month < 11) r = 0;
        if (daysLeft.rouge <= 0) { w += r; r = 0; }
        if (daysLeft.blanc <= 0) { b += w; w = 0; }

        let total = Math.max(1, r + w + b);
        let finalR = Math.round((r/total)*100);
        let finalW = Math.round((w/total)*100);
        let finalB = 100 - (finalR + finalW);

        return { ROUGE: finalR, BLANC: finalW, BLEU: Math.max(0, finalB) };
    }

    function renderProbs(rowsId, probs) {
        const config = [{id:'ROUGE',c:'var(--red)',v:probs.ROUGE},{id:'BLANC',c:'#fff',v:probs.BLANC},{id:'BLEU',c:'var(--blue)',v:probs.BLEU}];
        document.getElementById(rowsId).innerHTML = config.map(item => `
            <div class="prob-line">
                <span class="dot" style="background:${item.c};"></span>
                <div class="prob-bar-bg"><div class="prob-bar-fill" style="width:${item.v}%; background:${item.c}"></div></div>
                <span style="width:28px; text-align:right; font-size:0.6rem">${item.v}%</span>
            </div>`).join('');
    }

    async function updateWeather() {
        try {
            const res = await fetch("https://api.open-meteo.com/v1/forecast?latitude=48.8566&longitude=2.3522&daily=temperature_2m_min&timezone=Europe%2FBerlin");
            const data = await res.json(); const now = new Date(); const hour = now.getHours() + (now.getMinutes()/60);

            if (hour < 6.5) {
                const tomDate = new Date(); tomDate.setDate(tomDate.getDate() + 1);
                const p = calculateProb(data.daily.temperature_2m_min[1], currentGW, tomDate);
                const dominant = Object.keys(p).reduce((a, b) => p[a] > p[b] ? a : b);
                document.getElementById('text-tomorrow').innerText = dominant;
                document.getElementById('card-tomorrow').className = `card-rt is-${dominant.toLowerCase()}`;
            }

            [2, 3].forEach((off, i) => {
                const id = i === 0 ? "2" : "3"; 
                const targetDate = new Date(); targetDate.setDate(targetDate.getDate() + off);
                const temp = data.daily.temperature_2m_min[off];
                document.getElementById(`label-j${id}`).innerText = targetDate.toLocaleDateString('fr-FR', {weekday:'short', day:'2-digit'}).toUpperCase();
                document.getElementById(`temp-j${id}`).innerText = Math.round(temp) + "Â°C";
                renderProbs(`prob-rows-j${id}`, calculateProb(temp, currentGW, targetDate));
            });
        } catch (e) {}
    }

    async function updateTempo() {
        try {
            const [tRes, tomRes, sRes, statsRes] = await Promise.all([
                fetch("https://www.api-couleur-tempo.fr/api/jourTempo/today"),
                fetch("https://www.api-couleur-tempo.fr/api/jourTempo/tomorrow"),
                fetch("https://www.api-couleur-tempo.fr/api/stats"),
                fetch("https://raw.githubusercontent.com/Zuldar/Tempo_data/main/stats_fiabilite.json?t=" + Date.now())
            ]);
            
            const t = await tRes.json(), tom = await tomRes.json(), s = await sRes.json(), stats = await statsRes.json();
            
            // Mise Ã  jour des scores J+2 et J+3 depuis GitHub
            const scoreJ2 = stats.j2.total > 0 ? Math.round((stats.j2.success / stats.j2.total) * 100) : 100;
            const scoreJ3 = stats.j3.total > 0 ? Math.round((stats.j3.success / stats.j3.total) * 100) : 100;
            
            document.getElementById('val-j2').innerText = `${scoreJ2}%`;
            document.getElementById('val-j3').innerText = `${scoreJ3}%`;

            const findV = (obj, col) => { for (let [k, v] of Object.entries(obj)) { if (k.toLowerCase().includes(col)) return v; } return 0; };
            daysLeft.rouge = 22 - findV(s, 'rouge'); daysLeft.blanc = 43 - findV(s, 'blanc');
            
            const now = new Date(); const hour = now.getHours() + (now.getMinutes()/60);
            const badgeTom = document.getElementById('badge-tomorrow');

            if (hour < 6.5) {
                badgeTom.innerText = "ESTIMATION"; badgeTom.className = "badge-base badge-estimation";
            } else {
                badgeTom.innerText = hour < 11 ? "RTE" : "OFFICIEL";
                badgeTom.className = hour < 11 ? "badge-base badge-rte" : "badge-base badge-officiel";
                document.getElementById('text-tomorrow').innerText = labels[tom.codeJour] || 'ATTENTE';
                document.getElementById('card-tomorrow').className = `card-rt is-${(labels[tom.codeJour]||'attente').toLowerCase()}`;
            }

            document.getElementById('card-today').className = `card-rt is-${(labels[t.codeJour]||'attente').toLowerCase()}`;
            document.getElementById('text-today').innerText = labels[t.codeJour] || '...';
            document.getElementById('date-today').innerText = now.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit' });
            const dTom = new Date(); dTom.setDate(dTom.getDate() + 1);
            document.getElementById('date-tomorrow').innerText = dTom.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit' });

            const config = [{ n: 'BLEU', v: 300 - findV(s, 'bleu'), t: 300, g: 'var(--grad-blue)' }, { n: 'BLANC', v: daysLeft.blanc, t: 43, g: 'var(--grad-white)' }, { n: 'ROUGE', v: daysLeft.rouge, t: 22, g: 'var(--grad-rouge)' }];
            document.getElementById('stats-container').innerHTML = config.map(c => `<div class="bar-wrap"><div class="bar-info"><span>${c.n}</span> <span>${c.v} / ${c.t}</span></div><div class="bar-base"><div class="bar-fill" style="width:${(c.v/c.t)*100}%; background:${c.g}"></div></div></div>`).join('');
        } catch (e) {}
    }

    async function init() { await updateFlux(); await updateTempo(); await updateWeather(); }
    init();
    setInterval(updateFlux, 300000);
    setInterval(updateTempo, 600000);
    setInterval(updateWeather, 3600000);
</script>
</body>
</html>
